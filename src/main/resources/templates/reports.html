<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="sr">
<head th:replace="~{fragments/header :: head('Mesara ERP | BI Analitika')}"></head>
<style>
    /* STILOVI ZA EKRAN */
    .custom-pill { transition: 0.2s; font-size: 0.85rem; cursor: pointer; }
    .custom-pill:hover { border-color: #007bff !important; background: #f0f7ff !important; }
    .custom-pill input { margin-right: 6px; }
</style>

<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <div th:replace="~{fragments/header :: navbar}"></div>
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-3">
                    <div class="col-sm-12 text-center text-md-left">
                        <h2 class="m-0 font-weight-bold">
                            <i class="fas fa-file-invoice-dollar text-primary mr-2 d-print-none"></i>Izveštaj o
                            Analitici Poslovanja
                        </h2>
                    </div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">

                <div class="row" th:if="${topProducts != null}">
                    <div class="col-md-4" th:each="tp, iter : ${topProducts}">
                        <div class="info-box shadow-sm">
                            <span class="info-box-icon"
                                  th:classappend="${iter.index == 0 ? 'bg-warning' : (iter.index == 1 ? 'bg-secondary' : 'bg-orange')}">
                                <i class="fas fa-trophy text-white"></i>
                            </span>
                            <div class="info-box-content">
                                <span class="info-box-text text-muted small">Top Artikal #<span
                                        th:text="${iter.count}"></span></span>
                                <span class="info-box-number font-weight-bold" th:text="${tp.productName}"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-primary mb-4 bg-light p-4 rounded filter-section-interactive">
                    <form th:action="@{/reports}" method="get" id="filterForm">
                        <div class="row align-items-end mb-4">
                            <div class="col-md-3">
                                <label class="font-weight-bold">Od:</label>
                                <input type="date" name="from" class="form-control" th:value="${fromDate}">
                            </div>
                            <div class="col-md-3">
                                <label class="font-weight-bold">Do:</label>
                                <input type="date" name="to" class="form-control" th:value="${toDate}">
                            </div>
                            <div class="col-md-6 mt-3 mt-md-0 d-flex gap-2">
                                <button type="submit" class="btn btn-primary font-weight-bold w-50 shadow-sm mr-2">
                                    <i class="fas fa-sync-alt mr-2"></i> GENERIŠI
                                </button>
                                <button type="button" onclick="downloadPdf()"
                                        class="btn btn-danger font-weight-bold w-50 shadow-sm">
                                    <i class="fas fa-file-pdf mr-2"></i> PREUZMI PDF
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <span class="d-block font-weight-bold text-dark border-bottom border-primary pb-2 mb-3">
                                Radnje: <small class="ml-2"><a href="#" onclick="selectAll('storeIds')">Sve</a> | <a
                                    href="#" onclick="deselectAll('storeIds')">Poništi</a></small>
                            </span>
                            <div class="d-flex flex-wrap">
                                <label class="custom-pill d-inline-flex align-items-center bg-white border rounded-pill px-3 py-1 mr-2 mb-2 shadow-sm"
                                       th:each="s : ${stores}">
                                    <input type="checkbox" name="storeIds" th:value="${s.id}"
                                           th:checked="${selectedStoreIds != null && selectedStoreIds.contains(s.id)}">
                                    <span class="ml-2" th:text="${s.name}"></span>
                                </label>
                            </div>
                        </div>
                        <div class="mb-0">
                            <span class="d-block font-weight-bold text-dark border-bottom border-primary pb-2 mb-3">
                                Artikli: <small class="ml-2"><a href="#" onclick="selectAll('productIds')">Svi</a> | <a
                                    href="#" onclick="deselectAll('productIds')">Poništi</a></small>
                            </span>
                            <div class="d-flex flex-wrap">
                                <label class="custom-pill d-inline-flex align-items-center bg-white border rounded-pill px-3 py-1 mr-2 mb-2 shadow-sm"
                                       th:each="p : ${allProducts}">
                                    <input type="checkbox" name="productIds" th:value="${p.id}"
                                           th:checked="${selectedProductIds != null && selectedProductIds.contains(p.id)}">
                                    <span class="ml-2" th:text="${p.name}"></span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>

                <form id="pdfExportForm" th:action="@{/reports/pdf}" method="post" style="display: none;">
                    <input type="hidden" name="from" th:value="${fromDate}">
                    <input type="hidden" name="to" th:value="${toDate}">
                    <span th:if="${selectedStoreIds != null}">
                        <input type="hidden" name="storeIds" th:each="id : ${selectedStoreIds}" th:value="${id}">
                    </span>
                    <span th:if="${selectedProductIds != null}">
                        <input type="hidden" name="productIds" th:each="id : ${selectedProductIds}" th:value="${id}">
                    </span>

                    <input type="hidden" name="purchaseImg" id="purchaseImgInput">
                    <input type="hidden" name="salesImg" id="salesImgInput">
                    <input type="hidden" name="wasteImg" id="wasteImgInput">
                    <input type="hidden" name="barChartImg" id="barChartImgInput">
                </form>

                <div th:if="${reportData != null}" class="report-content-container">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-success text-white py-2"><h3
                                        class="card-title text-sm font-weight-bold m-0">Udeo Nabavke</h3></div>
                                <div class="card-body">
                                    <div class="chart-container-pie" style="height: 200px;">
                                        <canvas id="purchasePie"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-primary text-white py-2"><h3
                                        class="card-title text-sm font-weight-bold m-0">Udeo Prodaje</h3></div>
                                <div class="card-body">
                                    <div class="chart-container-pie" style="height: 200px;">
                                        <canvas id="salesPie"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-danger text-white py-2"><h3
                                        class="card-title text-sm font-weight-bold m-0">Udeo Otpisa</h3></div>
                                <div class="card-body">
                                    <div class="chart-container-pie" style="height: 200px;">
                                        <canvas id="wastePie"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-white py-2"><h3 class="card-title font-weight-bold m-0">Udeo radnji u
                            prometu artikala (kg)</h3></div>
                        <div class="card-body">
                            <div class="position-relative w-100" style="height: 450px;">
                                <canvas id="groupedChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm mb-0">
                        <div class="card-header bg-dark py-2">
                            <h3 class="card-title font-weight-bold text-white text-uppercase m-0">
                                TABELA PROMETA I BILANS STANJA
                            </h3>
                        </div>
                        <div class="card-body p-0 table-responsive">
                            <table class="table table-bordered table-striped text-center mb-0">
                                <thead class="bg-secondary text-white text-uppercase">
                                <tr>
                                    <th class="text-left align-middle">ARTIKAL</th>
                                    <th class="align-middle">NABAVKA</th>
                                    <th class="align-middle">PRODATO</th>
                                    <th class="align-middle">OTPIS</th>
                                    <th class="align-middle">STANJE</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="row : ${reportData}">
                                    <td class="text-left font-weight-bold align-middle"
                                        th:text="${row.productName}"></td>
                                    <td class="align-middle"
                                        th:text="${#numbers.formatDecimal(row.received, 1, 2)} + ' kg'"></td>
                                    <td class="align-middle"
                                        th:text="${#numbers.formatDecimal(row.sold, 1, 2)} + ' kg'"></td>
                                    <td class="align-middle"
                                        th:text="${#numbers.formatDecimal(row.waste, 1, 2)} + ' kg'"></td>
                                    <td class="align-middle font-weight-bold"
                                        th:with="stanje=${row.received - (row.sold + row.waste)}"
                                        th:text="${#numbers.formatDecimal(stanje, 1, 2)} + ' kg'"
                                        th:classappend="${stanje < 0 ? 'text-danger' : 'text-success'}">
                                    </td>
                                </tr>
                                </tbody>
                                <tfoot class="bg-dark text-white font-weight-bold text-uppercase">
                                <tr th:with="sumR=${#aggregates.sum(reportData.![received])},
                             sumS=${#aggregates.sum(reportData.![sold])},
                             sumW=${#aggregates.sum(reportData.![waste])}">
                                    <td class="text-left align-middle">UKUPNO:</td>
                                    <td class="align-middle"
                                        th:text="${#numbers.formatDecimal(sumR, 1, 2)} + ' kg'"></td>
                                    <td class="align-middle"
                                        th:text="${#numbers.formatDecimal(sumS, 1, 2)} + ' kg'"></td>
                                    <td th:text="${#numbers.formatDecimal(sumW, 1, 2)} + ' kg'"></td>
                                    <td class="align-middle"
                                        th:text="${#numbers.formatDecimal(sumR - (sumS + sumW), 1, 2)} + ' kg'"></td>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer th:replace="~{fragments/footer :: footer}"></footer>
</div>

<div th:replace="~{fragments/footer :: scripts}"></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">
    function selectAll(name) { document.querySelectorAll('input[name="' + name + '"]').forEach(el => el.checked = true); }
    function deselectAll(name) { document.querySelectorAll('input[name="' + name + '"]').forEach(el => el.checked = false); }

    // NOVA FUNKCIJA KOJA SAKUPLJA SLIKE I ŠALJE IH NA SERVER
    function downloadPdf() {
        // Pretvaramo kanvase u Base64 slike
        document.getElementById('purchaseImgInput').value = document.getElementById('purchasePie').toDataURL('image/png');
        document.getElementById('salesImgInput').value = document.getElementById('salesPie').toDataURL('image/png');
        document.getElementById('wasteImgInput').value = document.getElementById('wastePie').toDataURL('image/png');
        document.getElementById('barChartImgInput').value = document.getElementById('groupedChart').toDataURL('image/png');

        // Submittujemo skrivenu formu
        document.getElementById('pdfExportForm').submit();
    }

    $(document).ready(function() {
            const catData = [[${categoryData}]];
        if (catData) {
            const labels = catData.map(d => d.categoryName);
            const colors = ['#28a745', '#007bff', '#dc3545', '#ffc107', '#17a2b8', '#6610f2'];
            const config = (data) => ({
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: colors }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } }}
                }
            });
            new Chart(document.getElementById('purchasePie'), config(catData.map(d => d.totalReceived)));
            new Chart(document.getElementById('salesPie'), config(catData.map(d => d.totalSold)));
            new Chart(document.getElementById('wastePie'), config(catData.map(d => d.totalWaste)));
        }

        const labels = [[${labels}]];
        const contributions = [[${storeContributions}]];
        const storeNames = [[${uniqueStoreNames}]];
        if (labels && labels.length > 0) {
            const ctx = document.getElementById('groupedChart').getContext('2d');
            const findVal = (store, product, type) => {
                const entry = contributions.find(c => c.storeName === store && c.productName === product);
                return entry ? entry[type] : 0;
            };

            const datasets = [];
            storeNames.forEach((store, index) => {
                const opacity = 1 - (index * 0.15);
                datasets.push({ label: store + ' (U)', data: labels.map(l => findVal(store, l, 'received')), backgroundColor: `rgba(40, 167, 69, ${opacity})`, stack: '0' });
                datasets.push({ label: store + ' (P)', data: labels.map(l => findVal(store, l, 'sold')), backgroundColor: `rgba(0, 123, 255, ${opacity})`, stack: '1' });
                datasets.push({ label: store + ' (O)', data: labels.map(l => findVal(store, l, 'waste')), backgroundColor: `rgba(220, 53, 69, ${opacity})`, stack: '2' });
            });

            const displayLabels = labels.map(l => l.length > 30 ? l.substring(0, 30) + '...' : l);

            new Chart(ctx, {
                type: 'bar',
                data: { labels: displayLabels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { stacked: true, beginAtZero: true } },
                    plugins: { legend: { position: 'bottom', labels: { font: { size: 9 } } }}
                }
            });
        }
    });
</script>
</body>
</html>